//Atributos
var int_NumPagina = 1;
var int_TamPagina = 10;
var int_PagMostrar = 9;
var urlEdicion = 'NuevasCanciones.aspx';
var urlAprobarSolicitud = 'AprobarSolicitud.aspx';
var urlPrincipal = 'NuevasCanciones.aspx';



$(function () {
    CargarInicial();
    //$("#btnAgregar").click(function () {
    //    MostrarMensajeCargando();
    //    document.location.href = urlEdicion;
    //    return false;
    //});

    //$("#btnModificar").click(function () {
    //    Editar();
    //    return false;
    //});

    $("#btnAprobar").click(function () {
        Aprobar(); 
        return false;
    });

    $("#btnRechazar").click(function () {
        var obj_modal = $("#mdBuscador").modal('show', {
            backdrop: true,
            keyboard: false,
        });
        return false;
    });

    $("#btnBuscar").click(function () {
        ListarNuevasCanciones(1);
        return false;
    });

    KeyPressEnter("divFiltro",
        function () {
            $("#btnBuscar").click();
        });

    //CANCELAR MODAL
    $("#mdBuscador").find('.modal-footer .btn-cancelar').click(function () {
        $("#mdBuscador").modal('hide');
    });
    //ACEPTAR MODAL
    $("#mdBuscador").find('.modal-footer .btn-aceptar').click(function () {
        //ValidarResolucion();

            var str_pMotivo ="";
            str_pMotivo = $("#txtMotivo").val();
            if (str_pMotivo == "") {
                AlertJQ(1, 'El motivo es obligatorio.');
                return false;
            }
            Rechazar(str_pMotivo);
        
        return false;
    });

    $("#btnBuscar").focus();
    $('#ddlEmpresa').change(function () {
        CargarLocal(true, null);
    });
    ListarNuevasCanciones(1);



});
function CargarInicial() {
    var settings = $('#frmContent').validate().settings;
    $.extend(settings, {
        highlight: function (element) {
            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
        },
        success: function (element) {
            $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
        }
    });
}



function ObtenerFiltros() {
    var obj_Filtro = new Object();
    obj_Filtro.Titulo = $("#txtTitulo").val();
    obj_Filtro.Artista = $("#txtArtista").val();
    obj_Filtro.Album = $("#txtAlbum").val();

    obj_Filtro.IdGenero = null;
    if ($("#txtGenero").val() != '')
        obj_Filtro.IdGenero = $("#txtGenero").val();

    obj_Filtro.IdIdioma = null;
    if ($("#txtIdioma").val() != '')
        obj_Filtro.IdIdioma = $("#txtIdioma").val();

    //obj_Filtro.Estado = null;
    //if ($("#ddlEstado").val() != '')
    //    obj_Filtro.Estado = $("#ddlEstado").val();

    //obj_Filtro.IdEmpresa = null;
    //if ($("#ddlEmpresa").val() != '')
    //    obj_Filtro.IdEmpresa = $("#ddlEmpresa").val();

    //obj_Filtro.IdLocal = null;
    //if ($("#ddlLocal").val() != '')
    //    obj_Filtro.IdLocal = $("#ddlLocal").val();
    return obj_Filtro;
}

function ListarNuevasCanciones(int_pNumPagina) {
    int_NumPagina = int_pNumPagina;
    var obj_Filtro = ObtenerFiltros();
    var str_Estado = "P";
    var obj_Data = {
        "str_pTitulo": obj_Filtro.Titulo,
        "str_pArtista": obj_Filtro.Artista,
        "str_pAlbum": obj_Filtro.Album,
        "str_pGenero": obj_Filtro.IdGenero,
        "str_pIdioma": obj_Filtro.IdIdioma,
        "str_pEstado": str_Estado,
        "int_pNumPagina": int_pNumPagina,
        "int_pTamPagina": int_TamPagina
    };
    AccionDefault(true, "NuevasCanciones.aspx/ListarCancionesNuevas", obj_Data, CargarGrilla, null, null, null, 1);
}

function CargarGrilla(obj_pLista) {

    var obj_TablaPrincipal = $("<table id='tblCancion' class='table table-bordered table-hover dt-responsive'></table>");
    var obj_THead = $("<thead></thead>");
    var obj_FilaPrincipal = $("<tr></tr>");
    obj_FilaPrincipal.append($("<th style='width:10%;'>Cancion</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Artista</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Album</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Idioma</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Genero</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Youtube</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%;'>Estado</th>"));
    obj_THead.append(obj_FilaPrincipal);
    obj_TablaPrincipal.append(obj_THead);

    var str_Cancion = '';
    var str_Artista = '';
    var str_Album = '';
    var str_Idioma = '';
    var str_Genero = '';
    var str_Youtube = '';
    var str_Estado = '';

    var obj_TBody = $("<tbody></tbody>");
    for (var i = 0; i < obj_pLista.Result.length; i++) {

        str_Cancion = '';
        str_Artista = '';
        str_Album = '';
        str_Idioma = '';
        str_Genero = '';
        str_Youtube = '';
        str_Estado = '';

        obj_FilaPrincipal = $("<tr value='" + obj_pLista.Result[i].IdSolicitudCancion + "'></tr>");

        if (obj_pLista.Result[i].Cancion != null)
            str_Cancion = obj_pLista.Result[i].Cancion;
        obj_FilaPrincipal.append($("<td>" + str_Cancion + "</td>"));

        if (obj_pLista.Result[i].Artista != null)
            str_Artista = obj_pLista.Result[i].Artista;
        obj_FilaPrincipal.append($("<td>" + str_Artista + "</td>"));

        if (obj_pLista.Result[i].Album != null)
            str_Album = obj_pLista.Result[i].Album;
        obj_FilaPrincipal.append($("<td>" + str_Album + "</td>"));

        if (obj_pLista.Result[i].Idioma != null)
            str_Idioma = obj_pLista.Result[i].Idioma;
        obj_FilaPrincipal.append($("<td>" + str_Idioma + "</td>"));

        if (obj_pLista.Result[i].Genero != null)
            str_Genero = obj_pLista.Result[i].Genero;
        obj_FilaPrincipal.append($("<td>" + str_Genero + "</td>"));
     
        if (obj_pLista.Result[i].Youtube != null)
            str_Youtube = obj_pLista.Result[i].Youtube;
        obj_FilaPrincipal.append($("<td>" + str_Youtube + "</td>"));

        if (obj_pLista.Result[i].Estado == 'R')
            str_Estado = "Rechazado";
        if (obj_pLista.Result[i].Estado == 'A')
            str_Estado = "Aprobado";
        if (obj_pLista.Result[i].Estado == 'P')
            str_Estado = "Pendiente";

        obj_FilaPrincipal.append($("<td style='text-align:center'>" + str_Estado + "</td>"));

        obj_TBody.append(obj_FilaPrincipal);

    }
    obj_TablaPrincipal.append(obj_TBody);

    $("#divPaginacion").html('');
    $("#divPaginacion").append(CargarPaginacion(obj_pLista));

    $("#divGrilla").html('');
    $("#divGrilla").append(obj_TablaPrincipal);

    var obj_Tabla = $('#tblCancion').dataTable({
        "language": {
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron registros",
            "info": "Página _PAGE_ de _PAGES_",
            "infoEmpty": "",
            "infoFiltered": "(Filtrado hasta _MAX_ total registros)"
        },
        "processing": false,
        "bPaginate": false,
        "bLengthChange": false,
        "bFilter": false,
        "bSort": true,
        "bInfo": false,
        "bAutoWidth": false
    });

    $('#tblCancion tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        }
        else {
            obj_Tabla.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    });
}


function CargarPaginacion(obj_pLista) {
    var int_vNumPagina = int_NumPagina;
    var int_vPagMostrar = int_PagMostrar;
    var int_TotalRegistros = obj_pLista.Total;

    var obj_Ul = $("<ul class='pagination'></ul>");
    var obj_Li = $("<li class='paginate_button'></li>");
    obj_Ul.append(obj_Li);
    obj_Li.append(CrearNumeroPagina(int_vNumPagina, int_vNumPagina));

    while ((int_TotalRegistros - ((int_NumPagina - 1) * int_TamPagina) - int_TamPagina) > 0) {
        int_TotalRegistros = (int_TotalRegistros - int_TamPagina);
        int_vNumPagina++;
        int_vPagMostrar--;
        if (int_vPagMostrar > 0)
            obj_Li.append(CrearNumeroPagina(int_vNumPagina, int_vNumPagina));
        else {
            if (int_TotalRegistros > 0) {
                obj_Li.append(CrearNumeroPagina(int_vNumPagina, ">"));
                break;
            }
        }
    }

    int_vNumPagina = int_NumPagina;
    while ((int_TotalRegistros - int_TamPagina) > 0) {
        int_TotalRegistros = (int_TotalRegistros - int_TamPagina);
        int_vNumPagina--;
        int_vPagMostrar--;
        if (int_vPagMostrar > 0)
            obj_Li.prepend(CrearNumeroPagina(int_vNumPagina, int_vNumPagina));
    }
    if (int_vNumPagina > 1)
        obj_Li.prepend(CrearNumeroPagina(int_vNumPagina, "<"));

    var int_TotalPaginas = Math.ceil(obj_pLista.Total / int_TamPagina);
    int_TotalPaginas = int_TotalPaginas == 0 ? 1 : int_TotalPaginas;
    $("#divPaginacionInfo").html("Página " + int_NumPagina + " de " + int_TotalPaginas);

    return obj_Ul;
}

function CrearNumeroPagina(int_pNumPagina, str_pTexto) {
    var obj_AnchorPag = $("<a></a>");
    $(obj_AnchorPag).attr('href', '#');
    $(obj_AnchorPag).attr('onclick', 'ListarNuevasCanciones(' + (int_pNumPagina) + ');');
    $(obj_AnchorPag).text(str_pTexto);
    return obj_AnchorPag;
}

function obtenerIdRegistro() {
    var str_Id = null;
    var obj_Seleccion = $('#tblCancion').find('.selected');
    if (obj_Seleccion.length > 0)
        str_Id = $(obj_Seleccion[0]).attr('value');
    else
        AlertJQ(1, 'Seleccione una solicitud.');
    return str_Id;
}

function Editar() {
    var str_Id = obtenerIdRegistro();
    if (str_Id != null) {
        MostrarMensajeCargando();
        document.location.href = urlEdicion + "?id=" + str_Id;
    }
}



function ModificarEstado(str_pId, str_pEstado) {
    Accion('Cancion.aspx/ModificarEstado', { "int_pIdCancion": str_pId, "str_pEstado": str_pEstado }, function () { ListarCancion(1); });
}

function CargarLocal(bln_pAsync, int_pIdDireccion) {

    var ddlLocal = $("#ddlLocal");
    ddlLocal.empty();
    ddlLocal.html('');
    ddlLocal.append($("<option value=''>--Seleccione--</option>"));

    var int_IdPersona = $("#ddlEmpresa").val();
    if (int_IdPersona != '') {
        var obj_Data = { "int_pIdPersona": int_IdPersona };
        AccionDefault(bln_pAsync, "Cancion.aspx/ListarLocal", obj_Data,
             function (obj_pLista) {
                 //ddlNivel.prop("disabled", false);
                 var str_Selected = '';
                 for (var i = 0; i < obj_pLista.Result.length; i++) {
                     if (int_pIdDireccion != null)
                         str_Selected = (obj_pLista.Result[i].IdDireccion == IdDireccion) ? 'selected' : '';
                     ddlLocal.append($("<option value='" + obj_pLista.Result[i].IdDireccion + "' " + str_Selected + ">" + obj_pLista.Result[i].Direccion + "</option>"));
                 }
                 // ddlLocal.prop("disabled", true);
             }, null, null, null, 1);
    }
}


function Aprobar() {
    var str_Id = obtenerIdRegistro();
    if (str_Id != null) {
        MostrarMensajeCargando();
        document.location.href = urlAprobarSolicitud + "?id=" + str_Id;
    }
}

function Rechazar(str_pMotivo) {

        var str_Id = obtenerIdRegistro();
        var IdSolicitudCancion = str_Id;
        if (IdSolicitudCancion == null)
            return false;


        Accion('NuevasCanciones.aspx/RechazarSolicitud', { "int_pIdSolicitudCancion": IdSolicitudCancion, "str_pMotivo": str_pMotivo },
            function () { document.location.href = urlPrincipal; });

        $("#mdBuscador").modal('hide');
    
    return false;
}