//Atributos
var int_NumPagina = 1;
var int_TamPagina = 50;
var int_PagMostrar = 9;

$(function () {
    CargarInicial();
    CargarControles();
});
function CargarInicial() {
}
function CargarControles() {

    $(".datetime").datetimepicker({
        language: 'es',
        format: 'dd/mm/yyyy',
        pickerPosition: "bottom-left",
        autoclose: true,
        minView: 2,
        maxView: 4,
    });

    $("#txtFecha").datetimepicker({
        language: 'es',
        format: 'dd/mm/yyyy',
        pickerPosition: "bottom-left",
        autoclose: true,
        minView: 2,
        maxView: 4,
        startDate: new Date()
    });
    $('#btnExportar').click(function () {
        Exportar();
        return false;
    });
    KeyPressEnter("divFiltro",
    function () {
        $("#btnBuscar").click();
    });

    $("#btnBuscar").click(function () {
        ListarReporte(1);
        return false;
    });
    $('#ddlEmpresa').change(function () {
        CargarLocal(true, null);
    });
    //CargarGrilla(null);
    ListarReporte(1);

}

function CargarLocal(bln_pAsync, int_pIdDireccion) {

    var ddlLocal = $("#ddlLocal");
    ddlLocal.empty();
    ddlLocal.html('');
    ddlLocal.append($("<option value=''>--Seleccione--</option>"));

    var int_IdPersona = $("#ddlEmpresa").val();
    if (int_IdPersona != '') {
        var obj_Data = { "int_pIdPersona": int_IdPersona };
        AccionDefault(bln_pAsync, "ReporteAperturaMesa.aspx/ListarLocal", obj_Data,
             function (obj_pLista) {
                 //ddlNivel.prop("disabled", false);
                 var str_Selected = '';
                 for (var i = 0; i < obj_pLista.Result.length; i++) {
                     if (int_pIdDireccion != null)
                         str_Selected = (obj_pLista.Result[i].IdDireccion == IdDireccion) ? 'selected' : '';
                     ddlLocal.append($("<option value='" + obj_pLista.Result[i].IdDireccion + "' " + str_Selected + ">" + obj_pLista.Result[i].Direccion + "</option>"));
                 }
                 // ddlLocal.prop("disabled", true);
             }, null, null, null, 1);
    }
}


function Exportar() {
    $('body').prepend("<form id='excelForm' method='post' action='../../Ashx/Reporte/ReporteAperturaMesaExcel.ashx'></form>");
    $('#excelForm').submit();
    $("excelForm").remove();
}

function ObtenerFiltros() {
    var obj_Filtro = new Object();

    obj_Filtro.IdEmpresa = $("#ddlEmpresa").val();
    obj_Filtro.IdLocal = $("#ddlLocal").val();
    obj_Filtro.DesMozo = $("#txtMozo").val();

    obj_Filtro.FechaInicio = null;
    if ($("#txtFechaInicio_input").val() != '')
        obj_Filtro.FechaInicio = $("#txtFechaInicio").data("datetimepicker").getDate();

    obj_Filtro.FechaFin = null;
    if ($("#txtFechaFin_input").val() != '')
        obj_Filtro.FechaFin = $("#txtFechaFin").data("datetimepicker").getDate();

    obj_Filtro.IdUbicacionTipo = $("#ddlUbicacionTipo").val();
    obj_Filtro.NroUbicacion = $("#txtNroUbicacion").val();
    obj_Filtro.NumPagina = int_NumPagina;

    return obj_Filtro;
}

function ListarReporte() {
    var obj_Filtro = ObtenerFiltros();
    var obj_Data = {
        "str_pNombreCompleto": obj_Filtro.DesMozo,
        "int_pIdEmpresa": obj_Filtro.IdEmpresa,
        "int_pIdLocal": obj_Filtro.IdLocal,
        "dt_pFechaInicio": obj_Filtro.FechaInicio,
        "dt_pFechaFin": obj_Filtro.FechaFin,
        "int_pIdUbicacionTipo": obj_Filtro.IdUbicacionTipo,
        "int_pNroUbicacion": obj_Filtro.NroUbicacion,
        "int_pNumPagina": obj_Filtro.NumPagina,
        "int_pTamPagina": int_TamPagina
    };
    AccionDefault(true, "ReporteAperturaMesa.aspx/ReporteAperturaMesa", obj_Data, CargarGrilla, null, null, null, 1);
}

function CargarGrilla(obj_pLista) {

    var btn_Excel = $('#btnExportar');
    btn_Excel.css('display', 'none');

    var obj_TablaPrincipal = $("<table id='tblReporte' class='table table-bordered' style='width:99%;'></table>");
    var obj_THead = $("<thead></thead>");
    var obj_FilaPrincipal = $("<tr></tr>");
    obj_FilaPrincipal.append($("<th style='width:15%'>Empresa</th>"));
    obj_FilaPrincipal.append($("<th style='width:15%'>Local</th>"));
    obj_FilaPrincipal.append($("<th style='width:20%'>Mozo</th>"));
    obj_FilaPrincipal.append($("<th style='width:15%'>Fecha</th>"));
    obj_FilaPrincipal.append($("<th style='width:15%'>Tipo de Ubicación</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%'>Ubicación</th>"));
    obj_FilaPrincipal.append($("<th style='width:10%'>Mesa Abierta (min)</th>"));
    obj_THead.append(obj_FilaPrincipal);
    obj_TablaPrincipal.append(obj_THead);

    var obj_TBody = $("<tbody></tbody>");
    for (var i = 0; i < obj_pLista.Result.length; i++) {
        var str_FechaApertura = obj_pLista.Result[i].FechaApertura == null ? '' : ToDateString(obj_pLista.Result[i].FechaApertura);
        var str_UbicacionTipo = obj_pLista.Result[i].Alerta.Ubicacion.UbicacionTipo.Descripcion == null ? '' : obj_pLista.Result[i].Alerta.Ubicacion.UbicacionTipo.Descripcion;
        var str_Numero = obj_pLista.Result[i].Alerta.Ubicacion.Numero == null ? '' : obj_pLista.Result[i].Alerta.Ubicacion.Numero;
        var str_DiferenciaFechas = obj_pLista.Result[i].DiferenciaFechas == null ? '' : obj_pLista.Result[i].DiferenciaFechas;

        //var str_FechaAlerta = obj_pLista.Result[i].Alerta.FechaAlerta == null ? '' : ToDateTimeString(obj_pLista.Result[i].Alerta.FechaAlerta);
        //var str_FechaAtencion = obj_pLista.Result[i].Alerta.FechaAtencion == null ? '' : ToDateTimeString(obj_pLista.Result[i].FechaAtencion);

        obj_FilaPrincipal = $("<tr></tr>");
        obj_FilaPrincipal.append($("<td>" + obj_pLista.Result[i].Local.Empresa.NombreComercial + "</td>"));
        obj_FilaPrincipal.append($("<td>" + obj_pLista.Result[i].Local.Direccion + "</td>"));
        obj_FilaPrincipal.append($("<td>" + obj_pLista.Result[i].NombreCompleto + "</td>"));
        obj_FilaPrincipal.append($("<td>" + str_FechaApertura + "</td>"));
        obj_FilaPrincipal.append($("<td>" + str_UbicacionTipo + "</td>"));
        obj_FilaPrincipal.append($("<td>" + str_Numero + "</td>"));
        obj_FilaPrincipal.append($("<td>" + str_DiferenciaFechas + "</td>"));
        obj_TBody.append(obj_FilaPrincipal);
    }
    obj_TablaPrincipal.append(obj_TBody);

    //ListarGraficoApertura(obj_pLista);
    ListarAperturaMesaTop(1);
    ListarAperturaMesaMozoTop(1);

    if (obj_pLista.Result.length > 0)
        btn_Excel.css('display', '');

    //var int_TotalPaginas = Math.ceil(obj_pLista.Total / int_TamPagina) == 0 ? 1 : Math.ceil(obj_pLista.Total / int_TamPagina);
    //$("#divPaginacionInfo").html("Página " + int_NumPagina + " de " + int_TotalPaginas);

    //$("#divPaginacion").unbind();
    //$("#divPaginacion").bootpag({
    //    total: int_TotalPaginas,
    //    page: int_NumPagina,
    //    maxVisible: obj_pLista.Total == 0 ? 1 : int_PagMostrar
    //}).on('page', function (event, num) {
    //    ListarReporte(num);
    //});


    $("#divGrilla").html('');
    $("#divGrilla").append(obj_TablaPrincipal);

    var obj_Tabla = $('#tblReporte').dataTable({
        "scrollX": true,
        "language": {
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron registros",
            "info": "Página _PAGE_ de _PAGES_",
            "infoEmpty": "",
            "infoFiltered": "(Filtrado hasta _MAX_ total registros)"
        },
        "processing": false,
        "bPaginate": false,
        "bLengthChange": false,
        "bFilter": false,
        "bSort": true,
        "bInfo": false,
        "bAutoWidth": false
    });
}
function ListarAperturaMesaTop() {
    var obj_Filtro = ObtenerFiltros();
    var obj_Data = {
        "str_pNombreCompleto": obj_Filtro.DesMozo,
        "int_pIdEmpresa": obj_Filtro.IdEmpresa,
        "int_pIdLocal": obj_Filtro.IdLocal,
        "dt_pFechaInicio": obj_Filtro.FechaInicio,
        "dt_pFechaFin": obj_Filtro.FechaFin,
        "int_pIdUbicacionTipo": obj_Filtro.IdUbicacionTipo,
        "int_pNroUbicacion": obj_Filtro.NroUbicacion
    };
    AccionDefault(true, "ReporteAperturaMesa.aspx/ListarAperturaMesaTop", obj_Data, ListarGraficoApertura, null, null, null, 1);
}
function ListarGraficoApertura(obj_pLista) {
    var obj_data = [];
    var obj_tick = [];

    var str_pCantidadPedido = 0;
    var str_pCantidadUno = 0;
    var str_pCantidadDos = 0;
    var str_pCantidadTres = 0;
    var str_pCantidadCuatro = 0;
    var str_pCantidadCinco = 0;

    var str_pTitulo = "";
    var str_pTituloUno = "";
    var str_pTituloDos = "";
    var str_pTituloTres = "";
    var str_pTituloCuatro = "";
    var str_pTituloCinco = "";

    var str_pLocal = "";
    var str_pLocalUno = "";
    var str_pLocalDos = "";
    var str_pLocalTres = "";
    var str_pLocalCuatro = "";
    var str_pLocalCinco = "";

    var obj_TBody = $("<tbody></tbody>");
    for (var i = 0; i < obj_pLista.Result.length; i++) {

        str_pCantidadPedido = obj_pLista.Result[i].Cantidad;
        str_pLocal = obj_pLista.Result[i].Local.Direccion;

        if (obj_pLista.Result[i].Ubicacion.Numero != null && obj_pLista.Result[i].Ubicacion.Numero != "") {
            str_pTitulo = obj_pLista.Result[i].Ubicacion.UbicacionTipo.Descripcion + " " + obj_pLista.Result[i].Ubicacion.Numero;

            if (str_pCantidadPedido > str_pCantidadUno) {
                //Cantidad
                str_pCantidadCinco = str_pCantidadCuatro
                str_pCantidadCuatro = str_pCantidadTres
                str_pCantidadTres = str_pCantidadDos
                str_pCantidadDos = str_pCantidadUno
                str_pCantidadUno = str_pCantidadPedido
                //Mesa
                str_pTituloCinco = str_pTituloCuatro
                str_pTituloCuatro = str_pTituloTres
                str_pTituloTres = str_pTituloDos
                str_pTituloDos = str_pTituloUno
                str_pTituloUno = str_pTitulo
                //Local
                str_pLocalCinco = str_pLocalCuatro
                str_pLocalCuatro = str_pLocalTres
                str_pLocalTres = str_pLocalDos
                str_pLocalDos = str_pLocalUno
                str_pLocalUno = str_pLocal
            } else {
                if (str_pCantidadPedido > str_pCantidadDos) {
                    //Cantidad
                    str_pCantidadCinco = str_pCantidadCuatro
                    str_pCantidadCuatro = str_pCantidadTres
                    str_pCantidadTres = str_pCantidadDos
                    str_pCantidadDos = str_pCantidadPedido
                    //Mesa
                    str_pTituloCinco = str_pTituloCuatro
                    str_pTituloCuatro = str_pTituloTres
                    str_pTituloTres = str_pTituloDos
                    str_pTituloDos = str_pTitulo
                    //Local
                    str_pLocalCinco = str_pLocalCuatro
                    str_pLocalCuatro = str_pLocalTres
                    str_pLocalTres = str_pLocalDos
                    str_pLocalDos = str_pLocal

                } else {
                    if (str_pCantidadPedido > str_pCantidadTres) {
                        //Cantidad
                        str_pCantidadCinco = str_pCantidadCuatro
                        str_pCantidadCuatro = str_pCantidadTres
                        str_pCantidadTres = str_pCantidadPedido
                        //Mesa
                        str_pTituloCinco = str_pTituloCuatro
                        str_pTituloCuatro = str_pTituloTres
                        str_pTituloTres = str_pTitulo
                        //Local
                        str_pLocalCinco = str_pLocalCuatro
                        str_pLocalCuatro = str_pLocalTres
                        str_pLocalTres = str_pLocal
                    } else {
                        if (str_pCantidadPedido > str_pCantidadCuatro) {
                            //Cantidad
                            str_pCantidadCinco = str_pCantidadCuatro
                            str_pCantidadCuatro = str_pCantidadPedido
                            //Mesa
                            str_pTituloCinco = str_pTituloCuatro
                            str_pTituloCuatro = str_pTitulo
                            //Local
                            str_pLocalCinco = str_pLocalCuatro
                            str_pLocalCuatro = str_pLocal
                        } else {
                            if (str_pCantidadPedido > str_pCantidadCinco) {
                                str_pCantidadCinco = str_pCantidadPedido
                                str_pTituloCinco = str_pTitulo
                                str_pLocalCinco = str_pLocal

                            }
                        }
                    }
                }
            }
        }
    }
    obj_data.push([0, str_pCantidadUno]);
    obj_data.push([1, str_pCantidadDos]);
    obj_data.push([2, str_pCantidadTres]);
    obj_data.push([3, str_pCantidadCuatro]);
    obj_data.push([4, str_pCantidadCinco]);

    obj_tick.push([0, str_pTituloUno + "<br>" + str_pLocal]);
    obj_tick.push([1, str_pTituloDos + "<br>" + str_pLocalDos]);
    obj_tick.push([2, str_pTituloTres + "<br>" + str_pLocalTres]);
    obj_tick.push([3, str_pTituloCuatro + "<br>" + str_pLocalCuatro]);
    obj_tick.push([4, str_pTituloCinco + "<br>" + str_pLocalCinco]);

    var series = {
        color: "#3c8dbc",
        data: obj_data,
        lines: { show: false },
        bars: { show: true, barWidth: 0.5, align: 'center' }
    }

    somePlot = $.plot("#divGrafico1", [series], {
        grid: {
            hoverable: true,
            borderWidth: 1,
            borderColor: "#f3f3f3",
            tickColor: "#f3f3f3"
        },
        series: {
            bars: {
                show: true,
                barWidth: 0.5,
                align: "center"
            }
        },
        xaxis: {
            mode: "categories",
            ticks: obj_tick
        },
        tooltip: true,
        tooltipOpts: {
            content: "%y"
        }
    });

    var ctx = somePlot.getCanvas().getContext("2d");
    var data = somePlot.getData()[0].data;
    var xaxis = somePlot.getXAxes()[0];
    var yaxis = somePlot.getYAxes()[0];
    var offset = somePlot.getPlotOffset();
    ctx.font = "12px 'Segoe UI'";
    ctx.fillStyle = "black";
    for (var i = 0; i < data.length; i++) {
        var text = data[i][1] + '';
        var metrics = ctx.measureText(text);
        var xPos = (xaxis.p2c(data[i][0]) + offset.left) - metrics.width / 2;
        var yPos = yaxis.p2c(data[i][1]) + offset.top - 5;
        ctx.fillText(text, xPos, yPos);
    }
}

//***********************GRAFICO TOP 5 MOZO*****************
function ListarAperturaMesaMozoTop() {
    var obj_Filtro = ObtenerFiltros();
    var obj_Data = {
        "str_pNombreCompleto": obj_Filtro.DesMozo,
        "int_pIdEmpresa": obj_Filtro.IdEmpresa,
        "int_pIdLocal": obj_Filtro.IdLocal,
        "dt_pFechaInicio": obj_Filtro.FechaInicio,
        "dt_pFechaFin": obj_Filtro.FechaFin
    };
    AccionDefault(true, "ReporteAperturaMesa.aspx/ListarAperturaMesaMozoTop", obj_Data, ListarGraficoAperturaMesaMozo, null, null, null, 1);
}

function ListarGraficoAperturaMesaMozo(obj_pLista) {
    var obj_data = [];
    var obj_tick = [];

    var str_pCantidadPedido = 0;
    var str_pCantidadUno = 0;
    var str_pCantidadDos = 0;
    var str_pCantidadTres = 0;
    var str_pCantidadCuatro = 0;
    var str_pCantidadCinco = 0;

    var str_pTitulo = "";
    var str_pTituloUno = "";
    var str_pTituloDos = "";
    var str_pTituloTres = "";
    var str_pTituloCuatro = "";
    var str_pTituloCinco = "";

    var str_pLocal = "";
    var str_pLocalUno = "";
    var str_pLocalDos = "";
    var str_pLocalTres = "";
    var str_pLocalCuatro = "";
    var str_pLocalCinco = "";

    var obj_TBody = $("<tbody></tbody>");
    for (var i = 0; i < obj_pLista.Result.length; i++) {

        str_pCantidadPedido = obj_pLista.Result[i].Cantidad;
        str_pTitulo = obj_pLista.Result[i].NombreCompleto;
        str_pLocal = obj_pLista.Result[i].Local.Direccion;

        if (str_pCantidadPedido > str_pCantidadUno) {
            //Cantidad
            str_pCantidadCinco = str_pCantidadCuatro
            str_pCantidadCuatro = str_pCantidadTres
            str_pCantidadTres = str_pCantidadDos
            str_pCantidadDos = str_pCantidadUno
            str_pCantidadUno = str_pCantidadPedido
            //Genero
            str_pTituloCinco = str_pTituloCuatro
            str_pTituloCuatro = str_pTituloTres
            str_pTituloTres = str_pTituloDos
            str_pTituloDos = str_pTituloUno
            str_pTituloUno = str_pTitulo
            //Local
            str_pLocalCinco = str_pLocalCuatro
            str_pLocalCuatro = str_pLocalTres
            str_pLocalTres = str_pLocalDos
            str_pLocalDos = str_pLocalUno
            str_pLocalUno = str_pLocal
        } else {
            if (str_pCantidadPedido > str_pCantidadDos) {
                //Cantidad
                str_pCantidadCinco = str_pCantidadCuatro
                str_pCantidadCuatro = str_pCantidadTres
                str_pCantidadTres = str_pCantidadDos
                str_pCantidadDos = str_pCantidadPedido
                //Genero
                str_pTituloCinco = str_pTituloCuatro
                str_pTituloCuatro = str_pTituloTres
                str_pTituloTres = str_pTituloDos
                str_pTituloDos = str_pTitulo
                //Local
                str_pLocalCinco = str_pLocalCuatro
                str_pLocalCuatro = str_pLocalTres
                str_pLocalTres = str_pLocalDos
                str_pLocalDos = str_pLocal

            } else {
                if (str_pCantidadPedido > str_pCantidadTres) {
                    //Cantidad
                    str_pCantidadCinco = str_pCantidadCuatro
                    str_pCantidadCuatro = str_pCantidadTres
                    str_pCantidadTres = str_pCantidadPedido
                    //Genero
                    str_pTituloCinco = str_pTituloCuatro
                    str_pTituloCuatro = str_pTituloTres
                    str_pTituloTres = str_pTitulo
                    //Local
                    str_pLocalCinco = str_pLocalCuatro
                    str_pLocalCuatro = str_pLocalTres
                    str_pLocalTres = str_pLocal
                } else {
                    if (str_pCantidadPedido > str_pCantidadCuatro) {
                        //Cantidad
                        str_pCantidadCinco = str_pCantidadCuatro
                        str_pCantidadCuatro = str_pCantidadPedido
                        //Genero
                        str_pTituloCinco = str_pTituloCuatro
                        str_pTituloCuatro = str_pTitulo
                        //Local
                        str_pLocalCinco = str_pLocalCuatro
                        str_pLocalCuatro = str_pLocal
                    } else {
                        if (str_pCantidadPedido > str_pCantidadCinco) {
                            str_pCantidadCinco = str_pCantidadPedido
                            str_pTituloCinco = str_pTitulo
                            str_pLocalCinco = str_pLocal

                        }
                    }
                }
            }
        }
    }
    obj_data.push([0, str_pCantidadUno]);
    obj_data.push([1, str_pCantidadDos]);
    obj_data.push([2, str_pCantidadTres]);
    obj_data.push([3, str_pCantidadCuatro]);
    obj_data.push([4, str_pCantidadCinco]);

    obj_tick.push([0, str_pTituloUno + "<br>" + str_pLocal]);
    obj_tick.push([1, str_pTituloDos + "<br>" + str_pLocalDos]);
    obj_tick.push([2, str_pTituloTres + "<br>" + str_pLocalTres]);
    obj_tick.push([3, str_pTituloCuatro + "<br>" + str_pLocalCuatro]);
    obj_tick.push([4, str_pTituloCinco + "<br>" + str_pLocalCinco]);

    //obj_tick.push([4, "Ironía<br>Maná<br>Soprano Av. Arequipa"]);

    var series = {
        color: "#3c8dbc",
        data: obj_data,
        lines: { show: false },
        bars: { show: true, barWidth: 0.5, align: 'center' }
    }

    somePlot = $.plot("#divGrafico2", [series], {
        grid: {
            hoverable: true,
            borderWidth: 1,
            borderColor: "#f3f3f3",
            tickColor: "#f3f3f3"
        },
        series: {
            bars: {
                show: true,
                barWidth: 0.5,
                align: "center"
            }
        },
        xaxis: {
            mode: "categories",
            ticks: obj_tick
        },
        tooltip: true,
        tooltipOpts: {
            content: "%y"
        }
    });

    var ctx = somePlot.getCanvas().getContext("2d");
    var data = somePlot.getData()[0].data;
    var xaxis = somePlot.getXAxes()[0];
    var yaxis = somePlot.getYAxes()[0];
    var offset = somePlot.getPlotOffset();
    ctx.font = "12px 'Segoe UI'";
    ctx.fillStyle = "black";
    for (var i = 0; i < data.length; i++) {
        var text = data[i][1] + '';
        var metrics = ctx.measureText(text);
        var xPos = (xaxis.p2c(data[i][0]) + offset.left) - metrics.width / 2;
        var yPos = yaxis.p2c(data[i][1]) + offset.top - 5;
        ctx.fillText(text, xPos, yPos);
    }
}