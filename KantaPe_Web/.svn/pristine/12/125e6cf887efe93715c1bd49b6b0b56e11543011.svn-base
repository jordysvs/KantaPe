CREATE  Procedure [SecurityListarUsuario] 
/*
'**********************************************************************************
'*	Procedimiento almacenado de listado de usuarios
	para el usuario
'*	Input			: 	@pIdUsuario - Id del usuario,
						@pUsuarioRed - Usuario de red,
						@pNombreCompleto - Nombre del empleado,
						@pIdPerfil - id del perfil,
						@pEstado - estado,
						@pNumPagina - Número de pagina
						@pTamPagina - Cantidad de registros por pagina
'*	Output			: <Ninguno>
'*	Creado Por		: John Castillo
'*	Fec Creación		: 15/12/2014
'**********************************************************************************
*/
(
	@pIdUsuario varchar(20) = null,
	@pUsuarioRed varchar(20) = null,
	@pCodigo varchar(20) = null,
	@pNombreCompleto varchar(500) = null,
	@pIdPerfil varchar(20) = null,
	@pIdPersona int = null,
	@pSistema char(1) = null,
	@pEstado char(1) = null,
	@pNumPagina int = null,
	@pTamPagina int = null
)
As
Begin
		Select tbl.*
		from(
		Select
		ROW_NUMBER() OVER (ORDER BY U.IdUsuario ASC) AS Num_Fila,
		
			U.IdUsuario,
			U.IdPersona,
			U.Clave,
			U.UsuarioRed,
			U.FlagExpiracion,
			U.FechaExpiracion,
			U.FechaCambioClave,
			U.FechaOlvidoClave,
			U.FechaUltimoLogin,
			U.Sistema,
			U.Estado,
			U.UsuarioCreacion,
			U.FechaCreacion,
			U.UsuarioModificacion,
			U.FechaModificacion,

			P.IdPersona as CorePersona_IdPersona,
			P.Nombres as CorePersona_Nombres,
			P.ApellidoPaterno as CorePersona_ApellidoPaterno,
			P.ApellidoMaterno as CorePersona_ApellidoMaterno,
			P.Mail as CorePersona_Mail,
			P.IdTipoDocumento as CorePersona_IdTipoDocumento,
			P.NumeroDocumento as CorePersona_NumeroDocumento,
			P.Estado as CorePersona_Estado,

			COUNT(*) OVER() Total_Filas

			From SecurityUsuario U
			left join CorePersona P on
			U.IdPersona = P.IdPersona
			Where 
			(@pIdUsuario is null or U.IdUsuario = @pIdUsuario) AND
			(@pUsuarioRed is null or U.UsuarioRed = @pUsuarioRed) AND
			(@pCodigo is null or U.IdUsuario like '%' + @pCodigo + '%') AND
			(@pNombreCompleto is null or 
			(
			P.Nombres like '%' + @pNombreCompleto + '%' OR
			P.ApellidoPaterno like '%' + @pNombreCompleto + '%' OR
			P.ApellidoMaterno like '%' + @pNombreCompleto + '%' 
			)) AND
			(@pIdPersona is null or P.IdPersona = @pIdPersona) AND
			(@pSistema is null or U.Sistema = @pSistema) AND
			(@pEstado is null or U.Estado = @pEstado) AND
			(@pIdPerfil is null or U.IdUsuario IN (
				select IdUsuario
				from SecurityPerfilUsuario
				where IdPerfil = @pIdPerfil AND Estado = 'A'))
		) tbl
		WHERE (@pTamPagina IS NULL OR tbl.Num_Fila BETWEEN (@pNumPagina * @pTamPagina)- @pTamPagina + 1 AND (@pNumPagina * @pTamPagina));

End


